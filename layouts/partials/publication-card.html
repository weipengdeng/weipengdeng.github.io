{{ $page := . }}
{{ $authors := "" }}
{{ with $page.Params.authors }}{{ $authors = delimit . ", " }}{{ end }}
{{ $venue := $page.Params.venue }}
{{ $year := $page.Params.year }}
{{ $links := $page.Params.links }}
{{ $desc := $page.Params.description }}
{{ $pdfHref := "" }}
{{ $pdfDownload := false }}
{{ with $page.Resources.GetMatch "*.pdf" }}
  {{ $pdfHref = .RelPermalink }}
  {{ $pdfDownload = true }}
{{ end }}
{{ with $links }}
  {{ with .pdf }}
    {{ $candidate := printf "%v" . }}
    {{ if or (hasPrefix $candidate "http://") (hasPrefix $candidate "https://") }}
      {{ $pdfHref = $candidate }}
      {{ $pdfDownload = false }}
    {{ else if hasPrefix $candidate "/" }}
      {{ $pdfHref = $candidate }}
      {{ $pdfDownload = true }}
    {{ else }}
      {{ $res := $page.Resources.GetMatch $candidate }}
      {{ if $res }}
        {{ $pdfHref = $res.RelPermalink }}
        {{ $pdfDownload = true }}
      {{ else if not $pdfHref }}
        {{ $pdfHref = $candidate }}
        {{ $pdfDownload = true }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $awards := slice }}
{{ $awardInputs := slice }}
{{ with $page.Params.awards }}{{ $awardInputs = $awardInputs | append . }}{{ end }}
{{ with $page.Params.award }}{{ $awardInputs = $awardInputs | append . }}{{ end }}
{{ range $awardInputs }}
  {{ $raw := . }}
  {{ if reflect.IsSlice $raw }}
    {{ range $raw }}
      {{ $label := "" }}
      {{ $href := "" }}
      {{ if reflect.IsMap . }}
        {{ with .label }}{{ $label = . }}{{ end }}
        {{ if not $label }}{{ with .title }}{{ $label = . }}{{ end }}{{ end }}
        {{ if not $label }}{{ with .text }}{{ $label = . }}{{ end }}{{ end }}
        {{ with .link }}{{ $href = printf "%v" . }}{{ end }}
        {{ if not $href }}{{ with .href }}{{ $href = printf "%v" . }}{{ end }}{{ end }}
        {{ if not $href }}{{ with .url }}{{ $href = printf "%v" . }}{{ end }}{{ end }}
      {{ else if reflect.IsBool . }}
        {{ if . }}{{ $label = "Award" }}{{ end }}
      {{ else }}
        {{ $label = printf "%v" . }}
      {{ end }}
      {{ if $label }}{{ $awards = $awards | append (dict "label" $label "href" $href) }}{{ end }}
    {{ end }}
  {{ else }}
    {{ $label := "" }}
    {{ $href := "" }}
    {{ if reflect.IsMap $raw }}
      {{ with $raw.label }}{{ $label = . }}{{ end }}
      {{ if not $label }}{{ with $raw.title }}{{ $label = . }}{{ end }}{{ end }}
      {{ if not $label }}{{ with $raw.text }}{{ $label = . }}{{ end }}{{ end }}
      {{ with $raw.link }}{{ $href = printf "%v" . }}{{ end }}
      {{ if not $href }}{{ with $raw.href }}{{ $href = printf "%v" . }}{{ end }}{{ end }}
      {{ if not $href }}{{ with $raw.url }}{{ $href = printf "%v" . }}{{ end }}{{ end }}
    {{ else if reflect.IsBool $raw }}
      {{ if $raw }}{{ $label = "Award" }}{{ end }}
    {{ else }}
      {{ $label = printf "%v" $raw }}
    {{ end }}
    {{ if $label }}{{ $awards = $awards | append (dict "label" $label "href" $href) }}{{ end }}
  {{ end }}
{{ end }}

{{ $tags := slice }}
{{ with $page.Params.tags }}
  {{ range . }}{{ $tags = $tags | append . }}{{ end }}
{{ end }}

<div class="pub-card" data-pub-tags="{{ delimit $tags "," }}">
  {{ $thumb := $page.Resources.GetMatch "*thumbnail*" }}
  {{ if not $thumb }}
    {{ $matches := resources.Match "images/placeholder-thumb.png" }}
    {{ if gt (len $matches) 0 }}
      {{ $thumb = index $matches 0 }}
    {{ end }}
  {{ end }}
  {{ if $thumb }}
    {{ $img := $thumb.Fit "520x368 webp q80" }}
    <div class="pub-media">
      <a class="pub-thumb" href="{{ $page.RelPermalink }}" aria-label="Open publication">
        <img src="{{ $img.RelPermalink }}" alt="" loading="lazy" decoding="async" />
      </a>
      {{ if $awards }}
        <div class="award-row" aria-label="Awards">
          {{ range $awards }}
            {{ $label := .label }}
            {{ $href := .href }}
            {{ if $href }}
              {{ $isExternal := or (hasPrefix $href "http://") (hasPrefix $href "https://") }}
              <a class="badge badge--gold award-badge" href="{{ $href }}" title="{{ $label }}"{{ if $isExternal }} target="_blank" rel="noopener"{{ end }}>{{ $label }}</a>
            {{ else }}
              <span class="badge badge--gold award-badge" title="{{ $label }}">{{ $label }}</span>
            {{ end }}
          {{ end }}
        </div>
      {{ end }}
    </div>
  {{ else }}
    <a class="pub-thumb" href="{{ $page.RelPermalink }}" aria-label="Open publication">PDF</a>
  {{ end }}

  <div>
    <p class="pub-title"><a href="{{ $page.RelPermalink }}">{{ $page.Title }}</a></p>
    {{ if $authors }}<p class="pub-authors">{{ $authors }}</p>{{ end }}
    {{ if $venue }}<p class="pub-venue">{{ $venue }}{{ with $year }} Â· {{ . }}{{ end }}</p>{{ end }}
    {{ if $tags }}
      <div class="topic-row" aria-label="Publication tags">
        {{ range $tags }}
          {{ partial "topic-badge.html" . }}
        {{ end }}
      </div>
    {{ end }}

    {{ with $desc }}
      <p class="pub-abstract">{{ . }}</p>
    {{ end }}

    {{ $hasActions := false }}
    {{ if $pdfHref }}{{ $hasActions = true }}{{ end }}
    {{ with $links }}
      {{ if or .code .project }}{{ $hasActions = true }}{{ end }}
    {{ end }}

    {{ if $hasActions }}
      <div class="pub-actions">
        {{ if $pdfHref }}
          {{ $pdfIsExternal := or (hasPrefix $pdfHref "http://") (hasPrefix $pdfHref "https://") }}
          <a class="btn" href="{{ $pdfHref }}"{{ if $pdfIsExternal }} target="_blank" rel="noopener"{{ else if $pdfDownload }} download{{ end }}>PDF</a>
        {{ end }}
        {{ with $links }}
          {{ with .code }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">Code</a>{{ end }}
          {{ with .project }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">Project</a>{{ end }}
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>
