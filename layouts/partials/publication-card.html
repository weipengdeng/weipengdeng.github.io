{{ $page := . }}
{{ $authors := "" }}
{{ with $page.Params.authors }}{{ $authors = delimit . ", " }}{{ end }}
{{ $venue := $page.Params.venue }}
{{ $year := $page.Params.year }}
{{ $links := $page.Params.links }}
{{ $desc := $page.Params.description }}
{{ $ribbons := slice }}
{{ with $page.Params.awards }}
  {{ if reflect.IsSlice . }}
    {{ range . }}
      {{ $label := "" }}
      {{ if reflect.IsMap . }}
        {{ with .label }}{{ $label = . }}{{ end }}
        {{ if not $label }}{{ with .title }}{{ $label = . }}{{ end }}{{ end }}
        {{ if not $label }}{{ with .text }}{{ $label = . }}{{ end }}{{ end }}
      {{ else if reflect.IsBool . }}
        {{ if . }}{{ $label = "Award" }}{{ end }}
      {{ else }}
        {{ $label = printf "%v" . }}
      {{ end }}
      {{ if $label }}{{ $ribbons = $ribbons | append $label }}{{ end }}
    {{ end }}
  {{ else if reflect.IsMap . }}
    {{ $label := "" }}
    {{ with .label }}{{ $label = . }}{{ end }}
    {{ if not $label }}{{ with .title }}{{ $label = . }}{{ end }}{{ end }}
    {{ if not $label }}{{ with .text }}{{ $label = . }}{{ end }}{{ end }}
    {{ if $label }}{{ $ribbons = $ribbons | append $label }}{{ end }}
  {{ else if reflect.IsBool . }}
    {{ if . }}{{ $ribbons = $ribbons | append "Award" }}{{ end }}
  {{ else }}
    {{ $ribbons = $ribbons | append (printf "%v" .) }}
  {{ end }}
{{ end }}
{{ with $page.Params.award }}
  {{ if reflect.IsSlice . }}
    {{ range . }}
      {{ $label := "" }}
      {{ if reflect.IsMap . }}
        {{ with .label }}{{ $label = . }}{{ end }}
        {{ if not $label }}{{ with .title }}{{ $label = . }}{{ end }}{{ end }}
        {{ if not $label }}{{ with .text }}{{ $label = . }}{{ end }}{{ end }}
      {{ else if reflect.IsBool . }}
        {{ if . }}{{ $label = "Award" }}{{ end }}
      {{ else }}
        {{ $label = printf "%v" . }}
      {{ end }}
      {{ if $label }}{{ $ribbons = $ribbons | append $label }}{{ end }}
    {{ end }}
  {{ else if reflect.IsMap . }}
    {{ $label := "" }}
    {{ with .label }}{{ $label = . }}{{ end }}
    {{ if not $label }}{{ with .title }}{{ $label = . }}{{ end }}{{ end }}
    {{ if not $label }}{{ with .text }}{{ $label = . }}{{ end }}{{ end }}
    {{ if $label }}{{ $ribbons = $ribbons | append $label }}{{ end }}
  {{ else if reflect.IsBool . }}
    {{ if . }}{{ $ribbons = $ribbons | append "Award" }}{{ end }}
  {{ else }}
    {{ $ribbons = $ribbons | append (printf "%v" .) }}
  {{ end }}
{{ end }}

{{ $tags := slice }}
{{ with $page.Params.tags }}
  {{ range . }}{{ $tags = $tags | append . }}{{ end }}
{{ end }}

<div class="pub-card" data-pub-tags="{{ delimit $tags "," }}">
  {{ $thumb := $page.Resources.GetMatch "*thumbnail*" }}
  {{ if not $thumb }}
    {{ $matches := resources.Match "images/placeholder-thumb.png" }}
    {{ if gt (len $matches) 0 }}
      {{ $thumb = index $matches 0 }}
    {{ end }}
  {{ end }}
  {{ if $thumb }}
    {{ $img := $thumb.Fit "520x368 webp q80" }}
    <a class="pub-thumb" href="{{ $page.RelPermalink }}" aria-label="Open publication">
      {{ if $ribbons }}
        {{ range $i, $label := $ribbons }}
          <span class="pub-ribbon" style="--ribbon-offset: {{ printf "%.2frem" (mul $i 1.35) }};" title="{{ $label }}">{{ $label }}</span>
        {{ end }}
      {{ end }}
      <img src="{{ $img.RelPermalink }}" alt="" loading="lazy" decoding="async" />
    </a>
  {{ else }}
    <a class="pub-thumb" href="{{ $page.RelPermalink }}" aria-label="Open publication">PDF</a>
  {{ end }}

  <div>
    <p class="pub-title"><a href="{{ $page.RelPermalink }}">{{ $page.Title }}</a></p>
    {{ if $authors }}<p class="pub-authors">{{ $authors }}</p>{{ end }}
    {{ if $venue }}<p class="pub-venue">{{ $venue }}{{ with $year }} Â· {{ . }}{{ end }}</p>{{ end }}
    {{ if $tags }}
      <div class="topic-row" aria-label="Publication tags">
        {{ range $tags }}
          {{ partial "topic-badge.html" . }}
        {{ end }}
      </div>
    {{ end }}

    {{ with $desc }}
      <p class="pub-abstract">{{ . }}</p>
    {{ end }}

    {{ if $links }}
      <div class="pub-actions">
        {{ with $links.pdf }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">PDF</a>{{ end }}
        {{ with $links.code }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">Code</a>{{ end }}
        {{ with $links.project }}<a class="btn" href="{{ . }}" target="_blank" rel="noopener">Project</a>{{ end }}
      </div>
    {{ end }}
  </div>
</div>
